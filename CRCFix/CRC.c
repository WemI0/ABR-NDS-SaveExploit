#include <stdio.h>
#include <stdlib.h>

const unsigned int poly = 0x04C11DB7;

unsigned int reflect(unsigned int data, int bits) {
    unsigned int ret = 0;
    int i;
    for(i = bits-1; i>=0; i--) {
        if(data & 1) ret |= (1 << i);
        data >>= 1;
    }
    return ret;
}

unsigned int crc32(char* msg, int len) {
    unsigned int crc = 0xffffffff;
    int i, j;
    for(i = 0; i < len; i++) {
        crc ^= ((char)reflect(msg[i], 8) << 24);
        for(j = 8; j; j--) {
            crc = (crc << 1) ^ ((crc & 0x80000000) ? poly : 0x0);
        }
    }
    return reflect(crc, 32) ^ 0xffffffff;
}

int main(int argc, char **argv){
    if(argc < 2){
        printf("Usage: %s [file.sav]\n", argv[0]);
        return -1;
    }
    
    FILE *fp;
    fp = fopen(argv[1], "rb+");
    if(!fp) return -1;
    int crc = 0;
    unsigned char *Chunk = malloc(0x178);
    //Get chunks
    fseek(fp, 0x8, SEEK_SET);
    fread(Chunk, 1, 0x178, fp);
    //Get CRCs
    crc = crc32(Chunk, 0x178);
    //Write CRCs
    fseek(fp, 0x4, SEEK_SET);
    fwrite(&crc, sizeof(int),1, fp);
    fclose(fp);
    free(Chunk);
    return 0;
}